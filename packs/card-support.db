{"name":"Card Viewer","type":"script","author":"Ec9V2ZGmzbIQy7dB","img":"icons/svg/dice-target.svg","scope":"global","command":"var width = 150;\nvar height = 200;\n\nHooks.on('updateUser', function() {\n    if (game.showCardDialog._state != -1)\n        game.showCardDialog.render(true);\n})\n\n\nHooks.on('updateMacro', function() {\n    if (game.showCardDialog._state != -1)\n        game.showCardDialog.render(true);\n})\n\n\n\nclass CardDialog extends Dialog {\n    constructor(options) {\n        super(options);\n\n        this.data = {\n            title: \"Player's Card List\",\n            content: \"\",\n            buttons: {}\n        };\n    }\n\n    /** @override */\n    static get defaultOptions() {\n        return mergeObject(super.defaultOptions, {\n            width: 800\n        });\n    }\n\n    /** @override */\n    getData() {\n        var users = game.data.users;\n        var userCards = [];\n\n        for (let user of users) {\n            var cards = [];\n\n            if (user.flags.cardsupport != undefined) {\n                var macros = user.flags.cardsupport.chbMacroMap;\n                for (var i = 1; i < macros.length; ++i) {\n                    var macro = game.macros.get(macros[i]);\n                    cards.push({ id: macro.id, marked: macro.data.flags.world.marked, back: macro.data.flags.world.cardBack, img: macro.data.img });\n                }\n            }\n            userCards.push({ user: user.name, cards: cards });\n        }\n\n        return {\n            content: this.getContent(userCards),\n            buttons: {}\n        }\n    }\n\n    /** @override */\n    activateListeners(html) {\n        super.activateListeners(html);\n        html.find('.card-macro').on('mousedown', this._macroExcute.bind(this));\n        \n    }\n\n    getContent(userCards) {\n        var content = \"<div>\";\n\n        for (let user of userCards) {\n            content += \"<h2>\" + user.user + \"</h2><div>\";\n\n            for (let card of user.cards) {\n                content += '<div class=\"card-macro\"  data-id=\"' + card.id + '\" data-marked=\"' + card.marked + '\" style=\"width: ' + width + 'px; height: ' + height + 'px; display: inline-block; position: relative;\">';\n\n                if (game.user.isGM || card.marked == 1) {\n                    content += '<img width=\"' + width + '\" height=\"' + height + '\" src=\"' + card.img + '\">';\n\n                    if (game.user.isGM && card.marked == 1)\n                        content += '<div style=\"position: absolute;top: 0;left: 0;height: 100%;width: 100%;background-color: #ff000080;\"></div>'\n                } else\n                    content += '<img class=\"card-macro\" data-id=\"' + card.id + '\" width=\"' + width + '\" height=\"' + height + '\" src=\"' + card.back + '\">';\n                content += '</div> &nbsp &nbsp'\n            }\n            content += \"</div>\";\n        }\n\n        content += \"</div>\";\n        return content;\n    }\n\n    _macroExcute(event) {\n        var target = $(event.currentTarget)[0].dataset;\n        if (game.user.isGM || target.marked == 1)\n            game.macros.get(target.id).execute();\n    }\n\n}\n\ngame.showCardDialog = new CardDialog();\ngame.showCardDialog.render(true);","folder":null,"sort":0,"permission":{"default":0,"Ec9V2ZGmzbIQy7dB":3},"flags":{"core":{"sourceId":"Macro.CI1jrkw5kxXH6BBO"}},"_id":"8s8z22GGt1LWiK9i"}
